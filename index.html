<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>PyroPad</title>
  
  <script src="lib/firebase.js"></script>
  <script src="lib/codemirror.js"></script>
  <script src="lib/mode/javascript.js"></script>
  <script src="lib/mode/python.js"></script>
  <script src="lib/mode/clike.js"></script>
  <script src="lib/mode/haskell.js"></script>
  <link rel="stylesheet" href="lib/theme/midnight.css"/>
  <link rel="stylesheet" href="lib/codemirror.css" />
  <link rel="stylesheet" href="lib/firepad.css" />
  <link rel="stylesheet" href="lib/custom.css" />
  <script src="lib/firepad.min.js"></script>
  <script src="lib/socket.io-1.3.4.js"></script>
  <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.11.2/jquery.min.js"></script>
</head>

<body>
  <div id="controls">
    <select id="lang">
      <option>Java</option>
      <option>Python</option>
      <option>C</option>
      <option>C++</option>
      
    </select>
    <button onclick="sendCode()">Compile &amp; Run</button>
  </div>
  <div id="pad">
    <div id="firepad-container"></div>
    <div id="preresult">
    <pre id=""><code id="result"></code></pre></div>
  </div>
</body>

<script>
  var firepadRef = getRef();
  var socket = io('https://hidden-inlet-2774.herokuapp.com/');
  var codeMirror = CodeMirror(document.getElementById('firepad-container'), {
      lineNumbers: true,
      theme: 'midnight',
      mode: 'clike'
  });
  var firepad = Firepad.fromCodeMirror(firepadRef, codeMirror, {
      defaultText: 'print \'hello\''
  });
  var mode = {'c':'clike', 'c++':'clike', 'java':'clike'};
  var compi = {'java': 'javac', 'c++':'gcc', 'c':'gcc'};
  var ext = {'python':'py', 'haskell':'hs', 'java':'java', 'c':'c', 'c++':'cpp'};
  var compiler = 'python';
  var filename = 'solution.py';
  var setMode = 'python';

  $("#lang").change(function(e) {
    var lang = $(this).val().toLowerCase();
    console.log("lang is now " + lang);
    if(lang in mode) {
      setMode = mode[lang];
    }
    if(lang in compi) {
      compiler = compi[lang];
    }
    if(lang in ext) {
      filename = 'solution.' + ext[lang];
    }
    codeMirror.setOption("mode", setMode);
    console.log(lang + " " + compiler + " " + filename);
  });

  socket.on('output', function(output) {      
    var out = output.stdout.split("\n").join("<br>");
    var err = output.stderr.split("\n").join("<br>");
    var content = "<div id=\"result\">" + out + err + "</div";
    $("#result").replaceWith(content);
    
  });

  function getRef() {
    var ref = new Firebase('https://boiling-fire-6186.firebaseio.com/');
    var hash = window.location.hash.replace(/#/g, '');
    if (hash) {
      ref = ref.child(hash);
    } 
    else {
      ref = ref.push(); // generate unique location.
      window.location = window.location + '#' + ref.key(); // add it as a hash to the URL.
    }
    if (typeof console !== 'undefined')
      console.log('Firebase data: ', ref.toString());
    return ref;
  }

  function sendCode() {
    var code = firepad.getText();
    //Hack to fix \n error
    code = code.replace(/'/g, "\"");
    code = code.replace(/\\/g, "~@~@~@")
    code = code.replace(/~@~@~@n/g, "\\\\\/n");
    code = code.replace(/\/n/g, "n");
    code = code.replace(/~@~@~@/g, "\\");
    //console.log(code);
    socket.emit('compile', {filename:filename, compiler:compiler, code:code});
  }
</script>
</html>
